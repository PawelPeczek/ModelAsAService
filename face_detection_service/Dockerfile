FROM python:3.7-buster

RUN apt-get update && \
    apt-get install -y python3 python3-pip libssl-dev git-core git

ARG SERVER_IDENTITY_SERVICE_HOST
ARG SERVER_IDENTITY_SERVICE_PORT
ARG SERVER_IDENTITY_SERVICE_NAME
ARG DISCOVERY_SERVICE_HOST
ARG DISCOVERY_SERVICE_PORT
ARG DISCOVERY_SERVICE_NAME
ARG FACE_DETECTION_SERVICE_SECRET
ARG FACE_DETECTION_CHANNEL
ARG AGE_ESTIMATION_CHANNEL
ARG FACE_DETECTION_SERVICE_NAME

RUN groupadd docker_users
RUN useradd docker_user -g docker_users
RUN mkdir project project/weights
RUN chown -R docker_user:docker_users project
RUN wget --no-check-certificate 'https://github.com/PawelPeczek/RetinaFaceNet/releases/download/v1.0/FaceNet_resnet_50.pth' \
    -O project/weights/weights.pth
RUN git clone https://github.com/PawelPeczek/RetinaFaceNet.git
WORKDIR RetinaFaceNet
RUN pip install .
WORKDIR /
RUN git clone https://github.com/PawelPeczek/ModelAsAService.git
WORKDIR ModelAsAService/pipeline_sdk
RUN pip install .
WORKDIR /
COPY ./requirements.txt project/requirements.txt
RUN pip install -r project/requirements.txt

ENV SERVER_IDENTITY_SERVICE_HOST=$SERVER_IDENTITY_SERVICE_HOST
ENV SERVER_IDENTITY_SERVICE_PORT=$SERVER_IDENTITY_SERVICE_PORT
ENV SERVER_IDENTITY_SERVICE_NAME=$SERVER_IDENTITY_SERVICE_NAME
ENV DISCOVERY_SERVICE_HOST=$DISCOVERY_SERVICE_HOST
ENV DISCOVERY_SERVICE_PORT=$DISCOVERY_SERVICE_PORT
ENV DISCOVERY_SERVICE_NAME=$DISCOVERY_SERVICE_NAME
ENV FACE_DETECTION_SERVICE_SECRET=$FACE_DETECTION_SERVICE_SECRET
ENV FACE_DETECTION_CHANNEL=$FACE_DETECTION_CHANNEL
ENV AGE_ESTIMATION_CHANNEL=$AGE_ESTIMATION_CHANNEL
ENV RUN_SYNC_APP=true
ENV FACE_DETECTION_SERVICE_NAME=$FACE_DETECTION_SERVICE_NAME

COPY . project
RUN chmod ugo+x project/run_app.sh
WORKDIR project

ENTRYPOINT ./run_app.sh