FROM python:3.7-buster

ARG SERVER_IDENTITY_SERVICE_HOST="https://127.0.0.1"
ARG SERVER_IDENTITY_SERVICE_PORT=50002
ARG SERVER_IDENTITY_SERVICE_PATH="v1/server_identity_service/verify_service_identity"
ARG DISCOVERY_SERVICE_HOST="https://127.0.0.1"
ARG DISCOVERY_SERVICE_PORT=50003
ARG DISCOVERY_SERVICE_PATH="v1/discovery_service/locate_services"
ARG RESOURCES_MANAGER_SERVICE_SECRET
ARG RESOURCES_MANAGER_SERVICE_NAME

RUN groupadd docker_users
RUN useradd docker_user -g docker_users
RUN mkdir project
RUN chown -R docker_user:docker_users project
COPY ./requirements.txt project/requirements.txt
RUN python -m pip install -r project/requirements.txt

ENV SERVER_IDENTITY_SERVICE_HOST=$SERVER_IDENTITY_SERVICE_HOST
ENV SERVER_IDENTITY_SERVICE_PORT=$SERVER_IDENTITY_SERVICE_PORT
ENV SERVER_IDENTITY_SERVICE_PATH=$SERVER_IDENTITY_SERVICE_PATH
ENV DISCOVERY_SERVICE_HOST=$DISCOVERY_SERVICE_HOST
ENV DISCOVERY_SERVICE_PORT=$DISCOVERY_SERVICE_PORT
ENV DISCOVERY_SERVICE_PATH=$DISCOVERY_SERVICE_PATH
ENV RESOURCES_MANAGER_SERVICE_SECRET=$RESOURCES_MANAGER_SERVICE_SECRET
ENV RESOURCES_MANAGER_SERVICE_NAME=$RESOURCES_MANAGER_SERVICE_NAME

COPY . project
WORKDIR project

ENTRYPOINT python -m src.app