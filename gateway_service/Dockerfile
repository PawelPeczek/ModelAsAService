FROM python:3.7-alpine

RUN apk update && \
    apk add openssh postgresql-dev gcc linux-headers libc-dev libffi-dev

ARG SERVER_IDENTITY_SERVICE_HOST
ARG SERVER_IDENTITY_SERVICE_PORT
ARG SERVER_IDENTITY_SERVICE_PATH
ARG DISCOVERY_SERVICE_HOST
ARG DISCOVERY_SERVICE_PORT
ARG DISCOVERY_SERVICE_PATH
ARG GATEWAY_SERVICE_SECRET
ARG GATEWAY_JWT_SECRET
ARG OBJECT_DETECTION_CHANNEL
ARG GATEWAY_SERVICE_NAME

RUN addgroup docker_users
RUN adduser -S docker_user -G docker_users
RUN mkdir project
RUN chown -R docker_user:docker_users project
COPY ./requirements.txt project/requirements.txt
RUN python -m pip install -r project/requirements.txt

ENV SERVER_IDENTITY_SERVICE_HOST=$SERVER_IDENTITY_SERVICE_HOST
ENV SERVER_IDENTITY_SERVICE_PORT=$SERVER_IDENTITY_SERVICE_PORT
ENV SERVER_IDENTITY_SERVICE_PATH=$SERVER_IDENTITY_SERVICE_PATH
ENV DISCOVERY_SERVICE_HOST=$DISCOVERY_SERVICE_HOST
ENV DISCOVERY_SERVICE_PORT=$DISCOVERY_SERVICE_PORT
ENV DISCOVERY_SERVICE_PATH=$DISCOVERY_SERVICE_PATH
ENV GATEWAY_SERVICE_SECRET=$GATEWAY_SERVICE_SECRET
ENV GATEWAY_JWT_SECRET=$GATEWAY_JWT_SECRET
ENV OBJECT_DETECTION_CHANNEL=$OBJECT_DETECTION_CHANNEL
ENV GATEWAY_SERVICE_NAME=$GATEWAY_SERVICE_NAME

COPY . project
WORKDIR project

ENTRYPOINT python -m src.app